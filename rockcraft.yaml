name: charmed-mysql # the name of your ROCK
base: ubuntu:22.04 # the base environment for this ROCK
version: '8.0.31' # just for humans. Semantic versioning is recommended
summary: Charmed MySQL ROCK OCI # 79 char long summary
description: |
    MySQL built from the official MySQL package 
    from the MySQL repository and installs 
    mysql-shell.  For more information on ROCKs, visit 
    the https://github.com/canonical/rockcraft.
license: Apache-2.0 # your application's SPDX license
cmd:
    - /usr/bin/setpriv
    - --clear-groups
    - --reuid
    - mysql
    - --regid
    - mysql
    - --
    - /usr/sbin/mysqld
platforms: # The platforms this ROCK should be built on and run on
    amd64:

parts:
    mysql-repo:
        plugin: nil
        override-pull: |
            export DEBIAN_FRONTEND=noninteractive
            export CONFIG_VERSION="0.8.22-1"
            apt-get update
            apt-get install -y wget lsb-release gnupg
            wget -q https://dev.mysql.com/get/mysql-apt-config_${CONFIG_VERSION}_all.deb \
                -O /tmp/mysql-apt-config_${CONFIG_VERSION}_all.deb
            dpkg -i /tmp/mysql-apt-config_${CONFIG_VERSION}_all.deb
            apt-get update
    percona-repo:
        plugin: nil
        override-pull: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y wget lsb-release
            wget https://repo.percona.com/apt/percona-release_latest.$(lsb_release -sc)_all.deb
            dpkg -i percona-release_latest.$(lsb_release -sc)_all.deb
            apt-get update
    packages-deb:
        plugin: nil
        after:
            - mysql-repo
            - percona-repo
        stage-packages:
            - mysql-server
            - mysql-router
            - mysql-shell
            - percona-xtrabackup-80
            - util-linux
        override-stage: |
            craftctl default
            mkdir -p $CRAFT_STAGE/var/lib/mysql
            ln -s /root/parts/packages-deb/install/usr/lib/x86_64-linux-gnu/libnuma.so.1 /usr/lib/x86_64-linux-gnu/libnuma.so.1
            mysqld --initialize
            cp -r /varlib/mysql $CRAFT_STAGE/var/lib
            chown 1000:1000 $CRAFT_STAGE/var/lib/mysql
    non-root-user:
        plugin: nil
        after: [packages-deb]
        overlay-script: |
            # Create a user in the $CRAFT_OVERLAY chroot
            groupadd -R $CRAFT_OVERLAY -g 1000 mysql
            useradd -R $CRAFT_OVERLAY -M -r -g mysql -u 1000 mysql
        override-prime: |
            craftctl default
            # This is only needed until this bug is resolved with pebble
            # https://github.com/canonical/pebble/issues/189
            mkdir -p $CRAFT_PRIME/home/mysql
            array=( .bash_logout .bashrc .profile )
            for i in "${array[@]}"
            do
                cp /etc/skel/"$i" $CRAFT_PRIME/home/mysql
                chown 1000:1000 $CRAFT_PRIME/home/mysql/"$i"
            done
            mkdir -p $CRAFT_PRIME/var/lib/mysql-files
            mkdir -p $CRAFT_PRIME/var/run/mysqld
            chown -R 1000:1000 $CRAFT_PRIME/var/lib/mysql*
            chown -R 1000:1000 $CRAFT_PRIME/var/run/mysqld
